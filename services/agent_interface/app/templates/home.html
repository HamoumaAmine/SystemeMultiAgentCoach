<!-- services/agent_interface/app/templates/home.html --> 
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>SMARTCOACH - Accueil</title>

  <style>
    /* Animations douces */
    @keyframes floaty {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }
    .floaty { animation: floaty 3.5s ease-in-out infinite; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0px); }
    }
    .fade-up { animation: fadeUp .55s ease forwards; }

    /* Glass effect */
    .glass {
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.6);
    }

    .chat-bubble-user {
      background: #0f766e;
      color: white;
      border-radius: 18px 18px 4px 18px;
      padding: 8px 12px;
      font-size: 0.9rem;
      max-width: 80%;
      margin-left: auto;
    }
    .chat-bubble-coach {
      background: #e5e7eb;
      color: #111827;
      border-radius: 18px 18px 18px 4px;
      padding: 8px 12px;
      font-size: 0.9rem;
      max-width: 80%;
      margin-right: auto;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#0b3a66] via-[#0f5b7d] to-[#10b981] text-slate-900">

  <!-- Wrapper -->
  <div class="max-w-5xl mx-auto px-4 py-4 md:py-6">

    <!-- TOP BAR -->
    <div class="flex items-center justify-between mb-6 fade-up">
      <div class="flex items-center gap-3">
        <img src="/static/logo.png"
             class="w-12 h-12 rounded-xl bg-white p-1 floaty shadow-lg"
             alt="SMARTCOACH logo">
        <div>
          <h1 class="text-2xl font-extrabold tracking-tight text-white">SMARTCOACH</h1>
          <p class="text-xs text-white/80">Coach multi-agents ‚Ä¢ Sport ‚Ä¢ Nutrition ‚Ä¢ Sant√©</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="profileBtn"
          class="px-3 py-2 rounded-xl bg-white/90 hover:bg-white transition shadow text-sm font-medium">
          üë§ Mon profil
        </button>

        <button id="logoutBtn"
          class="px-3 py-2 rounded-xl bg-black text-white hover:bg-slate-800 transition shadow text-sm font-medium">
          D√©connexion
        </button>
      </div>
    </div>

    <!-- DASHBOARD CARD -->
    <div class="glass rounded-3xl shadow-xl p-6 md:p-7 fade-up" style="animation-delay:.05s">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-lg font-bold mb-2">Tableau de bord</h2>

          <!-- ‚úÖ NEW DISPLAY WITH ICONS -->
          <div class="space-y-2 text-slate-700">

            <p class="flex items-center gap-2 text-sm">
              <span class="w-7 h-7 grid place-items-center rounded-lg bg-blue-100 text-blue-700">üéØ</span>
              <span class="font-semibold">Objectif :</span>
              <span id="goalSummary"></span>
            </p>

            <p class="flex items-center gap-2 text-sm">
              <span class="w-7 h-7 grid place-items-center rounded-lg bg-emerald-100 text-emerald-700">üòä</span>
              <span class="font-semibold">Mood r√©cent :</span>
              <span id="moodSummary"></span>
            </p>

            <p class="flex items-center gap-2 text-sm">
              <span class="w-7 h-7 grid place-items-center rounded-lg bg-indigo-100 text-indigo-700">üìà</span>
              <span class="font-semibold">Progression :</span>
              <span id="progressSummary"></span>
            </p>

          </div>
        </div>

        <!-- petite ic√¥ne sport -->
        <div class="w-12 h-12 rounded-2xl grid place-items-center bg-gradient-to-br from-[#0b3a66] to-[#10b981] text-white shadow-md">
          üèãÔ∏è
        </div>
      </div>

      <!-- mini stats interactives -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-5">
        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <div class="text-xs text-slate-500">Motivation</div>
          <div class="flex items-center gap-2 mt-2">
            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
              <div id="motivationBar" class="h-2 bg-emerald-500 rounded-full" style="width:60%"></div>
            </div>
            <div id="motivationPct" class="text-xs font-semibold">60%</div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <div class="text-xs text-slate-500">Activit√© semaine</div>
          <div class="flex items-center gap-2 mt-2">
            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
              <div id="activityBar" class="h-2 bg-blue-600 rounded-full" style="width:40%"></div>
            </div>
            <div id="activityPct" class="text-xs font-semibold">40%</div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm">
          <div class="text-xs text-slate-500">√âquilibre nutrition</div>
          <div class="flex items-center gap-2 mt-2">
            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
              <div id="nutriBar" class="h-2 bg-orange-500 rounded-full" style="width:75%"></div>
            </div>
            <div id="nutriPct" class="text-xs font-semibold">75%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SERVICES GRID -->
    <div id="services"
         class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-6 fade-up"
         style="animation-delay:.12s"></div>

    <!-- BOTTOM SECTIONS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 fade-up" style="animation-delay:.18s">

      <!-- NEXT SESSION -->
      <div class="glass rounded-3xl shadow-lg p-5">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-base">Prochaine s√©ance</h3>
          <span class="text-xs bg-emerald-600 text-white px-2 py-1 rounded-full">Recommand√©e</span>
        </div>

        <div class="mt-4 space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <div class="w-9 h-9 rounded-xl bg-white grid place-items-center shadow">üî•</div>
            <div>
              <div class="font-semibold">Full body d√©butant</div>
              <div class="text-slate-700">~35 min ‚Ä¢ Intensit√© mod√©r√©e</div>
            </div>
          </div>

          <ul class="list-disc ml-6 text-slate-800">
            <li>√âchauffement 5 min</li>
            <li>Squats 3√ó12</li>
            <li>Pompes 3√ó10</li>
            <li>Gainage 3√ó30s</li>
          </ul>

          <button class="mt-3 w-full bg-black text-white rounded-xl py-2 hover:bg-slate-800 transition">
            Voir le programme complet
          </button>
        </div>
      </div>

      <!-- LAST MEAL -->
      <div class="glass rounded-3xl shadow-lg p-5">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-base">Dernier repas scann√©</h3>
          <span id="mealDateBadge" class="text-xs bg-blue-600 text-white px-2 py-1 rounded-full">Aujourd‚Äôhui</span>
        </div>

        <div class="mt-4 flex gap-4">
          <!-- image placeholder -->
          <div class="w-28 h-28 rounded-2xl bg-white shadow overflow-hidden grid place-items-center">
            <img id="mealImg" src="https://picsum.photos/200" class="w-full h-full object-cover" alt="meal">
          </div>

          <div class="flex-1 text-sm space-y-1">
            <div class="font-semibold" id="mealTitle">Aucun repas scann√© pour l‚Äôinstant</div>
            <div class="text-slate-700" id="mealDesc">Scanne un repas pour voir l‚Äôanalyse ici.</div>

            <div class="flex flex-wrap gap-2 mt-2">
              <span id="mealKcal" class="text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full hidden">-</span>
              <span id="mealProt" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full hidden">-</span>
              <span id="mealCarb" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full hidden">-</span>
              <span id="mealFat" class="text-xs bg-pink-100 text-pink-800 px-2 py-1 rounded-full hidden">-</span>
            </div>

            <button id="rescanMealBtn"
                    class="mt-3 w-full bg-white rounded-xl py-2 shadow hover:shadow-md transition">
              üì∏ Scanner un repas
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- COACH CHAT (texte + vocal + photo) -->
    <div class="glass rounded-3xl shadow-lg p-5 mt-6 fade-up" style="animation-delay:.22s">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-base">Coach IA ‚Äì Chat, Vocal & Photo repas</h3>
        <span id="voiceStatus" class="text-xs text-slate-600">Micro : inactif</span>
      </div>

      <div id="chatMessages" class="bg-white/70 rounded-2xl p-3 h-56 overflow-y-auto space-y-2 text-sm mb-3">
        <!-- messages ajout√©s dynamiquement -->
      </div>

      <div class="space-y-2">
        <textarea id="coachInput"
                  rows="2"
                  class="w-full border rounded-2xl p-2 text-sm"
                  placeholder="D√©cris ton √©tat, pose une question √† ton coach..."></textarea>

        <div class="flex flex-wrap gap-2">
          <button id="sendTextBtn"
                  class="flex-1 bg-black text-white rounded-2xl py-2 text-sm hover:bg-slate-800 transition">
            Envoyer au coach
          </button>

          <button id="photoBtn"
                  class="flex-1 bg-indigo-600 text-white rounded-2xl py-2 text-sm hover:bg-indigo-700 transition">
            üì∏ Envoyer une photo
          </button>

          <button id="voiceBtn"
                  class="flex-1 bg-emerald-600 text-white rounded-2xl py-2 text-sm hover:bg-emerald-700 transition">
            üéôÔ∏è Enregistrer un vocal
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL PROFIL -->
  <div id="profileModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 fade-up">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Profil utilisateur</h3>
        <button id="closeProfile" class="text-slate-500 hover:text-black">‚úñ</button>
      </div>

      <div class="space-y-2 text-sm">
        <p><span class="text-slate-500">Nom :</span> <b id="pName">...</b></p>
        <p><span class="text-slate-500">Email :</span> <b id="pEmail">...</b></p>
        <p><span class="text-slate-500">√Çge :</span> <b id="pAge">...</b></p>
        <p><span class="text-slate-500">Taille :</span> <b id="pHeight">...</b></p>
        <p><span class="text-slate-500">Poids :</span> <b id="pWeight">...</b></p>
        <p><span class="text-slate-500">Objectif :</span> <b id="pGoal">...</b></p>
        <p><span class="text-slate-500">S√©ances/sem :</span> <b id="pSessions">...</b></p>
      </div>

      <a href="/ui/onboarding"
         class="block text-center w-full bg-black text-white rounded-xl py-2 hover:bg-slate-800 transition">
        Modifier mon profil
      </a>
    </div>
  </div>

  <!-- INPUT CACH√â POUR UPLOAD / PHOTO REPAS -->
  <input id="mealImageInput"
         type="file"
         accept="image/*"
         capture="environment"
         class="hidden" />

<script>
/* ---------- Helpers ---------- */
function getToken(){ return localStorage.getItem("token"); }
function logout(){
  localStorage.removeItem("token");
  window.location.href = "/ui/login";
}

/* ---------- Services icons mapping ---------- */
const ICONS = {
  coach: "ü§ñ",
  sport: "üèãÔ∏è",
  nutri: "üçΩÔ∏è",
  mood: "üòä",
  photo: "üì∏",
  stats: "üìà"
};

/* ---------- R√©f√©rences carte repas ---------- */
const mealImg      = document.getElementById("mealImg");
const mealTitleEl  = document.getElementById("mealTitle");
const mealDescEl   = document.getElementById("mealDesc");
const mealKcalEl   = document.getElementById("mealKcal");
const mealProtEl   = document.getElementById("mealProt");
const mealCarbEl   = document.getElementById("mealCarb");
const mealFatEl    = document.getElementById("mealFat");
const mealDateBadge = document.getElementById("mealDateBadge");
const mealImageInput = document.getElementById("mealImageInput");

/* ---------- Mise √† jour de la carte 'Dernier repas scann√©' ---------- */
function updateMealCard(meal){
  if(!meal) return;

  // Titre + description
  if(meal.title){
    mealTitleEl.textContent = meal.title;
  }
  if(meal.description){
    mealDescEl.textContent = meal.description;
  }

  // Image (si backend renvoie une URL)
  if(meal.image_url){
    mealImg.src = meal.image_url;
  }

  // Date (optionnelle)
  if(meal.scanned_at){
    mealDateBadge.textContent = meal.scanned_at;
  }

  // Macros / calories
  function showBadge(el, value, suffix){
    if(value === null || value === undefined || value === ""){
      el.classList.add("hidden");
    } else {
      el.textContent = value + suffix;
      el.classList.remove("hidden");
    }
  }

  showBadge(mealKcalEl, meal.kcal, " kcal");
  showBadge(mealProtEl, meal.proteins_g, " g P");
  showBadge(mealCarbEl, meal.carbs_g, " g G");
  showBadge(mealFatEl,  meal.fats_g, " g L");
}

/* ---------- Load dashboard ---------- */
async function loadDashboard(){
  const token = getToken();
  const res = await fetch("/dashboard/", {
    headers: {"Authorization":"Bearer " + token}
  });
  if(!res.ok){ logout(); return; }

  const d = await res.json();

  document.getElementById("goalSummary").innerText = d.goal_summary;
  document.getElementById("moodSummary").innerText = d.mood_summary;
  document.getElementById("progressSummary").innerText = d.progress_summary;

  // Si le backend renvoie le dernier repas scann√©
  if(d.last_meal){
    updateMealCard(d.last_meal);
  }

  // Services cards
  const container = document.getElementById("services");
  container.innerHTML = d.services.map((s, i) => `
    <a href="/ui${s.route}"
       class="glass rounded-3xl shadow-lg p-5 hover:shadow-2xl hover:-translate-y-1 transition fade-up"
       style="animation-delay:${0.2 + i*0.05}s">

      <div class="flex items-center justify-between">
        <div>
          <div class="text-base font-semibold">${s.title}</div>
          <div class="text-sm text-slate-800/80 mt-1">${s.subtitle}</div>
        </div>
        <div class="w-10 h-10 rounded-2xl bg-white shadow grid place-items-center text-lg">
          ${ICONS[s.key] || "‚ú®"}
        </div>
      </div>
    </a>
  `).join("");
}

/* ---------- Load profile ---------- */
async function loadProfile(){
  const token = getToken();
  const meRes = await fetch("/auth/me", { headers: {"Authorization":"Bearer " + token}});
  const profileRes = await fetch("/profile/", { headers: {"Authorization":"Bearer " + token}});

  if(meRes.ok){
    const me = await meRes.json();
    document.getElementById("pName").innerText = me.firstname + " " + me.lastname;
    document.getElementById("pEmail").innerText = me.email;
  }
  if(profileRes.ok){
    const p = await profileRes.json();
    const prof = p.profile || {};
    document.getElementById("pAge").innerText = prof.age ?? "-";
    document.getElementById("pHeight").innerText = (prof.height_cm ?? "-") + " cm";
    document.getElementById("pWeight").innerText = (prof.weight_kg ?? "-") + " kg";
    document.getElementById("pGoal").innerText = prof.goal ?? "-";
    document.getElementById("pSessions").innerText = prof.sessions_per_week ?? "-";
  }
}

/* ---------- Modal events ---------- */
const modal = document.getElementById("profileModal");
document.getElementById("profileBtn").addEventListener("click", async () => {
  modal.classList.remove("hidden");
  modal.classList.add("flex");
  await loadProfile();
});
document.getElementById("closeProfile").addEventListener("click", () => {
  modal.classList.add("hidden");
  modal.classList.remove("flex");
});
modal.addEventListener("click", (e) => {
  if(e.target === modal){
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
});

/* ---------- Logout ---------- */
document.getElementById("logoutBtn").addEventListener("click", logout);

/* ---------- Chat helpers ---------- */
const chatBox = document.getElementById("chatMessages");
const voiceStatus = document.getElementById("voiceStatus");
const coachInput = document.getElementById("coachInput");

function addChatMessage(role, text){
  const div = document.createElement("div");
  div.className = role === "user" ? "chat-bubble-user" : "chat-bubble-coach";
  div.innerText = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------- Envoi texte ---------- */
document.getElementById("sendTextBtn").addEventListener("click", async () => {
  const token = getToken();
  if(!token){ logout(); return; }

  const text = coachInput.value.trim();
  if(!text) return;

  addChatMessage("user", text);
  coachInput.value = "";

  const res = await fetch("/coach/", {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token
    },
    body: JSON.stringify({ text })
  });

  if(!res.ok){
    addChatMessage("coach", "Oups, le coach est indisponible pour le moment.");
    return;
  }
  const data = await res.json();
  addChatMessage("coach", data.answer || "Pas de r√©ponse du coach.");

  // Si le backend renvoie aussi une info repas (ex : depuis vision)
  if(data.meal){
    updateMealCard(data.meal);
  }
});

/* ---------- Envoi image / repas ---------- */
async function sendMealImage(file){
  const token = getToken();
  if(!token){ logout(); return; }
  if(!file) return;

  addChatMessage("user", "üì∏ J‚Äôai envoy√© une photo de mon repas, peux-tu l‚Äôanalyser ?");

  const formData = new FormData();
  formData.append("file", file, file.name || "meal.jpg");

  // üîó Endpoint √† impl√©menter c√¥t√© backend :
  // - re√ßoit l‚Äôimage
  // - appelle orchestrator / agent_vision / agent_knowledge
  // - renvoie : { answer: "...", meal: { title, description, image_url, kcal, proteins_g, carbs_g, fats_g, scanned_at } }
  const res = await fetch("/coach/photo-meal", {
    method: "POST",
    headers: {
      "Authorization":"Bearer " + token
    },
    body: formData
  });

  if(!res.ok){
    addChatMessage("coach", "Erreur lors de l‚Äôanalyse de l‚Äôimage de ton repas.");
    return;
  }

  const data = await res.json();
  if(data.answer){
    addChatMessage("coach", data.answer);
  } else {
    addChatMessage("coach", "L‚Äôimage a √©t√© re√ßue mais je n‚Äôai pas pu analyser ce repas.");
  }

  if(data.meal){
    updateMealCard(data.meal);
  }
}

function handleMealImageChange(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  sendMealImage(file);
  // reset pour pouvoir re-s√©lectionner la m√™me image si besoin
  e.target.value = "";
}

mealImageInput.addEventListener("change", handleMealImageChange);

document.getElementById("photoBtn").addEventListener("click", () => {
  mealImageInput.click();
});

document.getElementById("rescanMealBtn").addEventListener("click", () => {
  mealImageInput.click();
});

/* ---------- Voice recording ---------- */
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

async function toggleRecording(){
  const token = getToken();
  if(!token){ logout(); return; }

  if(!isRecording){
    // d√©marrage
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => {
        if(e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        voiceStatus.innerText = "Micro : envoi du vocal...";
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("file", blob, "voice.webm");

        const res = await fetch("/coach/voice", {
          method: "POST",
          headers: {
            "Authorization":"Bearer " + token
          },
          body: formData
        });

        if(!res.ok){
          addChatMessage("coach", "Erreur lors de la transcription du vocal.");
          voiceStatus.innerText = "Micro : inactif";
          return;
        }

        const data = await res.json();
        addChatMessage("coach", data.answer || "Pas de r√©ponse du coach.");
        voiceStatus.innerText = "Micro : inactif";

        // Si une analyse de repas est aussi renvoy√©e
        if(data.meal){
          updateMealCard(data.meal);
        }
      };

      mediaRecorder.start();
      isRecording = true;
      voiceStatus.innerText = "Micro : enregistrement...";
      document.getElementById("voiceBtn").innerText = "‚èπÔ∏è Arr√™ter le vocal";
    } catch (err){
      console.error(err);
      voiceStatus.innerText = "Micro : permission refus√©e";
    }
  } else {
    // arr√™t
    if(mediaRecorder){
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
    isRecording = false;
    document.getElementById("voiceBtn").innerText = "üéôÔ∏è Enregistrer un vocal";
  }
}

document.getElementById("voiceBtn").addEventListener("click", toggleRecording);

/* ---------- Init ---------- */
loadDashboard();
</script>
</body>
</html>
